<!DOCTYPE html>
<html lang="en">
<head>
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'"> -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css">
    <title>EleXcel</title>
</head>
<body style="height: 100vh;">
    <div class="container h-100">
        <div class="row">
            <div class="col-sm-2"></div>
            <div class="col-sm-8">
                <div class="card mt-5">
                    <div class="card-body">
                        <form action="" method="post" enctype="multipart/form-data" id="myform">
                            <div class="mb-2">
                                <label for="address_pt" class="form-label">Alamat PT.</label>
                                <input class="form-control" type="text" name="address_pt" id="address_pt" placeholder="Alamat PT" required>
                            </div>
                            <div class="mb-2">
                                <label for="exp_date" class="form-label">Tanggal Jatuh Tempo</label>
                                <input class="form-control" type="date" name="exp_date" id="exp_date" placeholder="Tanggal Jatuh Tempo" required>
                            </div>
                            <div class="mb-2">
                                <label for="created_at" class="form-label">Tanggal Dibuat</label>
                                <input class="form-control" type="date" name="created_at" id="created_at" placeholder="Tanggal Dibuat" required>
                            </div>
                            <div class="mb-2">
                                <label for="file_skrd" class="form-label">File SKRD</label>
                                <input class="form-control" type="file" name="file_skrd" id="file_skrd" placeholder="File SKRD" required>
                            </div>
                            <input class="btn btn-primary btn-block" type="submit" value="Proses">
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-sm-2"></div>
        </div>
    </div>
    <script src="https://unpkg.com/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>
    <script>
        const { app, BrowserWindow } = require('@electron/remote');
        const path = require('path');
        const fs = require('fs');
        function ConvTgl(params) {
            let refmont = ['Januari','Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            let date = new Date(params);
            let day = null;
            if (date.getDate() < 10) {
                day = "0"+date.getDate()
            }else{
                day = date.getDate()
            }

            return day +" "+refmont[date.getMonth()]+" "+date.getFullYear();

        }

        function mywind(examp){
            const win = new BrowserWindow({
                show: false,
                webPreferences: {
                    nodeIntegration:true,
                    contextIsolation: false,
                }
            })

            win.webContents.openDevTools();
        
            win.loadFile(path.join(__dirname, 'skrd.html'));

            win.webContents.send('data', examp);

            win.webContents.on('did-finish-load', () => {
                win.webContents.printToPDF({
                    // marginsType: 1,
                    //paper F4
                    pageSize: {
                        height: 13,//inch
                        width: 8.5,//inch
                    },
                    printBackground: true,
                    printSelectionOnly: false,
                    landscape: false
                }).then(data => {
                    fs.writeFile(app.getPath('downloads')+"/"+examp.namefile+".pdf", data, function (err) {
                        if (err) {
                            console.log(err);
                        } else {
                            console.log('PDF Generated Successfully');
                            alert('PDF Generated Successfully');
                        }
                    });
                }).catch(error => {
                    console.log(error)
                });
            });
        }

        let input = document.getElementById('file_skrd')
        let myform = document.getElementById('myform')
        myform.addEventListener('submit', function(e) {
            e.preventDefault(); 
            try {
                readXlsxFile(input.files[0], { sheet:5 }).then((rows) => {
                    let obj = new Object();

                    obj.tahun = 2023;
                    obj.data = rows;
                    obj.exp_date = ConvTgl(myform.elements['exp_date'].value);
                    obj.created_at = ConvTgl(myform.elements['created_at'].value);
                    obj.address_pt = myform.elements['address_pt'].value;

                    rows.forEach((e, i) => {
                        if (e[0] && !Number.isInteger(e[0])) {
                            if (e[0].substr(0, 4) == 'PT. ') {
                                obj.namefile=e[0];
                            }
                        }      
                    });
                    mywind(obj);
                });
            } catch (error) {
                console.log(error);
            }           
        })
    </script>
</body>
</html>